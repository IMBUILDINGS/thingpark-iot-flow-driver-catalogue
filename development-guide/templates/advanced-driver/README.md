# Advanced driver guide

This example describes how to create an advanced driver using ThingPark X IoT Flow framework. It assumes you
already followed the simple driver tutorial [here](../simple-driver/README.md). We are going to transform this
simple driver to illustrate how to deal with more complex source code.

So first, why a driver composed of several files is considered a more advanced use case ? ThingPark X IoT Flow framework
is executing drivers in a sandbox. In order to do that the code must be standalone and must not rely on any
external libraries. Also, drivers are loaded and unloaded dynamically and there is no concept of dynamic libraries in
JavaScript frameworks. So in order to emulate that, the JavaScript library needs to be bundled in a standalone source
file. The produced code must be executable using a simple `eval` function. This is achieved using the `webpack` tool
and this will be illustrated in the following sections.

## Code split

In the simple driver example we used a utility function to `readShort` values. We now want to refactor our code to
extract this part in a separated file. For this, create a new file named `util.js` and paste the following code:

```js
function readShort(bin) {
    var result = bin & 0xffff;
    if (0x8000 & result) {
        result = -(0x010000 - result);
    }
    return result;
}

exports.readShort = readShort;
```

Also, remove the `readShort` function from `index.js` and replace it with a require declaration to load the code from
our previously created file `util.js`:

```js
var util = require("./util");

...
```

Also replace any call to `readShort(...)` with `util.readShort(...)`. Verify everything is working by running the
tests `npm test`.

You now have an advanced driver composed of 2 files `index.js` and `util.js`.

## Code bundling

As explained in the introduction, we will now use `webpack` tool to bundle the code in a standalone source file. For this, ensure you have
`webpack` command installed. You need to use at least `4.43.0` version. You can check its version with:

```shell
webpack --version
```

Now create a file named `webpack.config.js` at the project root with content:

```js
const path = require("path");

module.exports = {
    mode: "production",
    entry: "./index.js",
    output: {
        filename: "main.js",
        path: path.resolve(__dirname, "."),
        library: "driver",
    },
};
```

This is a configuration file used by `webpack` to pack the source code. The `entry` property must point to the
entrypoint file of your library (here `index.js`). The `output.filename` is the name of the bundled code that will
be generated by `webpack`. `output.library` is defining the JavaScript variable in which all your library functions
will be exposed in the bundled code. This is an internal configuration and it must be equal to `driver` to work with
ThingPark X IoT Flow Framework.

After that you can generate the bundled code using the command:

```shell
webpack
```

It will produce a bundled file under `main.js`. The produced code is not really readable, it is a minified
version of the library suitable to be executed in a sandbox and this is what we are aiming.

Next step will be to automate the code bundling while compiling the code

## Automate bundling

For this, you need to add the webpack dependency, using this command:

```shell
npm install --save-dev webpack webpack-cli
```

To automatically produce the bundled code while compiling the project using `npm run build`, you have to modify the
`build` sub-command. For this, in `package.json` in `scripts` section add the new build definition like this:

```json
  ...
  "scripts": {
    "build": "webpack",
    ...
  }
  ...
```

Now when running `npm run build` it will automatically produce the `main.js`

## Driver packaging

To build a valid driver for ThingPark X IoT Flow framework, you need to update the main JavaScript file of your library
to use the bundled code. For this, edit the `package.json` and change the value of the property named `main` to `main.js`
like this:

```json
  ...
  "main": "main.js",
  ...
```

As you have seen, the bundled code produced by `webpack` is not really readable and re-usable. To prevent ThingPark X
IoT Flow framework from exposing this code to the end user you need to add the `private` property in `driver` section of
the `package.json` like this:

```json
  ...
  "driver": {
    "private": true,
    ...
  }
  ...
```

From there, you can produce your driver using the usual command to build the package:

```shell
npm pack
```

## Limitations

As discussed in previous section, a driver exposing bundled code must be `private` and code cannot be exposed to
the end user. Therefore, the driver cannot be re-used or modified. This is a temporary limitation and multi-file drivers
will be supported in the future.

It is not supported to use native code
